generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Creator {
  id             String        @id @default(cuid())
  name           String?
  ofUsername      String?       // The actual OnlyFans username (e.g. "angiyang")
  avatarUrl      String?
  headerUrl      String?       // OF profile header/banner image URL
  telegramId     String        // Agency owner's Telegram ID (same for all creators in agency)
  ofapiToken     String?
  ofapiCreatorId String?       @unique
  lastSyncCursor String?
  telegramGroupId String?      // Optional: Routes this specific creator's alerts to a specific Group ID
  
  hourlyTarget   Float         @default(100.0)
  whaleAlertTarget Float       @default(200.0)
  active         Boolean       @default(true)
  
  fans           Fan[]
  mediaAssets    MediaAsset[]
  assignedUsers  CreatorAssignment[]
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

enum Role {
  UNASSIGNED
  AGENCY
  CFO
  EMPLOYEE
}

model CreatorAssignment {
  id        String   @id @default(cuid())
  userId    String
  creatorId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, creatorId])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          Role      @default(UNASSIGNED)
  accounts      Account[]
  sessions      Session[]
  assignments   CreatorAssignment[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model MediaAsset {
  id             String        @id @default(cuid())
  creatorId      String
  creator        Creator       @relation(fields: [creatorId], references: [id])
  ofapiMediaId   String        @unique
  fileType       String
  originalName   String?
  totalRevenue   Float         @default(0.00)
  aiTitle        String?
  aiDescription  String?

  transactions   Transaction[]
  createdAt      DateTime      @default(now())
}

model Fan {
  id              String        @id @default(cuid())
  ofapiFanId      String        @unique
  creatorId       String
  name            String?
  username        String?
  lifetimeSpend   Float         @default(0)
  lastPurchaseAt  DateTime?     // Last tip/PPV/purchase timestamp
  lastPurchaseType String?      // tip, message, post, subscription
  lastPurchaseAmount Float?     // Amount of last purchase

  // --- Fan intelligence (detected from messages) ---
  fanType         String?       // submissive, dominant, romantic, transactional, lonely
  tonePreference  String?       // playful, assertive, romantic, direct
  priceRange      String?       // low (1-10), mid (10-50), high (50+), whale (200+)
  lastIntentAt    DateTime?     // Last time they showed buying intent
  intentScore     Int?          // 0-100 how likely to buy right now

  // --- Responsiveness & timing ---
  avgReplyTimeSec Int?          // Rolling average reply time in seconds
  activeHours     String?       // JSON array of top active hours e.g. "[22,23,0,1]"
  lastMessageAt   DateTime?     // Last time this fan sent a message
  followUpDueAt   DateTime?     // Next scheduled follow-up

  // --- Purchase behavior profile ---
  buyerType       String?       // ppv_buyer, custom_buyer, tipper, subscriber_only, window_shopper
  conversionRate  Float?        // PPV sent → PPV bought ratio
  avgOrderValue   Float?        // Average purchase amount
  discountSensitivity String?   // never, sometimes, always
  chargebackRisk  Boolean       @default(false)

  // --- Objections ---
  lastObjection   String?       // objection_price, objection_trust, objection_value, etc.
  topObjection    String?       // Most frequent objection tag

  // --- Relationship stage ---
  stage           String?       // new, warming, active_buyer, cooling_off, at_risk, churned
  stageUpdatedAt  DateTime?

  // --- Content format preference ---
  formatPreference String?      // photo, video, audio, text_chat, bundle
  lengthPreference String?      // short, medium, long
  customInterestLevel Int?      // 0-100

  // --- Conversation quality signals ---
  timeWasterScore Int?          // 0-100
  toxicityFlag    Boolean       @default(false)
  toxicityReason  String?
  agentEffortMinutes Float?     // Estimated minutes spent on this fan

  // --- Identity & context (only if volunteered) ---
  language        String?
  timezone        String?
  relationshipStatus String?
  occupationCategory String?

  creator         Creator       @relation(fields: [creatorId], references: [id])
  transactions    Transaction[]
  preferences     FanPreference[]
  intentEvents    FanIntentEvent[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([creatorId])
  @@index([lastPurchaseAt])
  @@index([fanType])
  @@index([stage])
  @@index([buyerType])
  @@index([followUpDueAt])
  @@index([timeWasterScore])
  @@index([lastMessageAt])
}

// What a fan is into — tags with evidence
model FanPreference {
  id              String        @id @default(cuid())
  fanId           String
  tag             String        // e.g. "roleplay", "customs", "audio", "gfe", "dominant"
  weight          Float         @default(1.0)  // How strongly associated (1-10)
  lastSeenAt      DateTime      @default(now())
  sourceMessageId String?       // OFAPI message ID where this was detected
  source          String?       // "auto" (AI detected) or "manual" (agent tagged)

  fan             Fan           @relation(fields: [fanId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([fanId, tag])
  @@index([fanId])
  @@index([tag])
}

// Buying intent signals — detected from fan messages
model FanIntentEvent {
  id              String        @id @default(cuid())
  fanId           String
  intentTag       String        // ready_to_buy, wants_custom, price_question, discount_request, etc.
  confidence      Float         @default(0.5) // 0-1 how confident the detection is
  messageId       String?       // OFAPI message ID
  messageText     String?       // Short excerpt of what they said
  createdAt       DateTime      @default(now())

  fan             Fan           @relation(fields: [fanId], references: [id], onDelete: Cascade)

  @@index([fanId, createdAt])
  @@index([intentTag])
}

// Chatter QA reviews — scores per conversation
model ChatQAReview {
  id              String        @id @default(cuid())
  creatorId       String        // Which model account
  chatterId       String?       // Which chatter handled this (User.id)
  fanId           String?       // Which fan
  chatId          String?       // OFAPI chat ID
  // Scores 0-5
  controlScore    Int?          // Conversation control
  tensionScore    Int?          // Tension / playfulness
  valueScore      Int?          // Value & objection handling
  personalizationScore Int?     // Personalization to fan type
  compliancePass  Boolean?      // Safety compliance
  // Tags
  mistakeTags     String[]      // permission_asking, flat_ack, no_cta, discount_too_fast
  strengthTags    String[]      // good_push_pull, strong_cta, adapted_to_fan
  agentStyle      String?       // direct, playful, warm, efficient
  fanTypeGuess    String?       // submissive, dominant, romantic, transactional, lonely
  outcome         String?       // ppv_bought, no_sale, follow_up_set
  notes           String?       // Free text reviewer notes
  createdAt       DateTime      @default(now())

  @@index([creatorId, createdAt])
  @@index([chatterId])
}

model Transaction {
  id             String        @id @default(cuid())
  ofapiTxId      String        @unique
  fanId          String
  creatorId      String?       // Optional for backward compat — backfilled by cron
  amount         Float
  type           String?       // tip, message, post, subscription, stream, referral
  date           DateTime

  fan            Fan           @relation(fields: [fanId], references: [id])
  mediaAssetId   String?
  mediaAsset     MediaAsset?   @relation(fields: [mediaAssetId], references: [id])

  createdAt      DateTime      @default(now())

  @@index([creatorId, date])
  @@index([date])
}
